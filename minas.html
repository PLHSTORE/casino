<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mines — Mini Juegos (Moderno)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f1724;
    --card:#0b1220;
    --glass: rgba(255,255,255,0.04);
    --glass-2: rgba(255,255,255,0.03);
    --glass-border: rgba(255,255,255,0.06);
    --muted: rgba(255,255,255,0.65);
    --accent1-start:#7c3aed;
    --accent1-end:#06b6d4;
    --accent2-start:#f59e0b;
    --accent2-end:#ef4444;
    --success:#10b981;
    --danger:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:
      radial-gradient(800px 400px at 10% 10%, rgba(124,58,237,0.06), transparent 10%),
      radial-gradient(700px 350px at 90% 80%, rgba(6,182,212,0.04), transparent 10%),
      var(--bg);
    color:#e6eef8;
    -webkit-font-smoothing:antialiased;
    padding:28px;
  }

  .container{
    max-width:1100px;margin:0 auto;
  }

  header{
    display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;
  }
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#071025,#0b1220);display:grid;place-items:center;border:1px solid rgba(255,255,255,0.03)}
  h1{font-size:18px;margin:0}
  p.sub{margin:0;color:var(--muted);font-size:13px}

  main{display:grid;grid-template-columns:1fr 360px;gap:22px;align-items:start}

  /* Left: game card */
  .game-card{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:16px;padding:18px;border:1px solid var(--glass-border);
    box-shadow: 0 10px 30px rgba(2,6,23,0.6);
  }
  .top-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  .controls{display:flex;gap:10px;align-items:center}
  .select, .input {
    background:var(--glass);border:1px solid var(--glass-border);padding:10px 12px;border-radius:10px;color:inherit;
  }
  .btn{
    padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent1-start),var(--accent1-end));
    color:white;font-weight:700;cursor:pointer;box-shadow:0 8px 30px rgba(124,58,237,0.14);
  }
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);box-shadow:none;color:var(--muted)}
  .btn.warn{background:linear-gradient(90deg,var(--accent2-start),var(--accent2-end));box-shadow:0 8px 30px rgba(245,158,11,0.12)}

  .board-wrap{display:flex;gap:18px;align-items:flex-start}
  .board{
    width:100%;max-width:640px;
    display:grid;
    grid-template-columns:repeat(5, 1fr);
    gap:10px;
  }
  .cell{
    background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
    border-radius:10px;padding:14px;display:grid;place-items:center;height:74px;
    cursor:pointer;border:1px solid rgba(255,255,255,0.02);font-weight:700;font-size:20px;transition:transform .16s ease, box-shadow .16s ease, background .18s;
    user-select:none;position:relative;overflow:hidden;
  }
  .cell:hover{transform:translateY(-6px);box-shadow:0 20px 40px rgba(2,6,23,0.6)}
  .cell.revealed{transform:none;box-shadow:none;cursor:default;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03)}
  .cell.bomb{background:linear-gradient(90deg, rgba(239,68,68,0.14), rgba(239,68,68,0.06));color: #fff;}
  .cell.good{background:linear-gradient(90deg, rgba(16,185,129,0.07), rgba(34,197,94,0.02));color:#e6fee9}

  .cell .icon {
    font-size:24px;opacity:0;transform:scale(.7);transition:opacity .18s, transform .18s;
  }
  .cell.revealed .icon{opacity:1;transform:scale(1)}
  .cell .pulse{
    position:absolute;inset:0;border-radius:10px;pointer-events:none;opacity:0;transform:scale(.8);
  }
  .cell.good .pulse{background:radial-gradient(circle at center, rgba(16,185,129,0.12), transparent 35%);opacity:1;animation:pop .8s ease;}
  .cell.bomb .pulse{background:radial-gradient(circle at center, rgba(239,68,68,0.12), transparent 35%);opacity:1;animation:shake .9s ease;}

  @keyframes pop{0%{transform:scale(.9);opacity:0}50%{transform:scale(1.05);opacity:1}100%{transform:scale(1);opacity:1}}
  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-4px)}100%{transform:translateX(0)}}

  /* Right panel */
  .panel{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:16px;padding:18px;border:1px solid var(--glass-border);height:100%;
    position:sticky;top:28px;
  }
  .stat{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;margin-bottom:8px;background:var(--glass-2);border:1px solid rgba(255,255,255,0.02)}
  .stat strong{font-size:16px}
  .small{color:var(--muted);font-size:13px}

  .footer-note{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}

  /* modal */
  .modal{position:fixed;inset:0;display:grid;place-items:center;background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.85));z-index:70;opacity:0;visibility:hidden;transition:opacity .18s, visibility .18s}
  .modal.open{opacity:1;visibility:visible}
  .modal-card{background:linear-gradient(180deg,#0b1220,#071026);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);width:540px;box-shadow:0 30px 80px rgba(2,6,23,0.7)}

  /* responsive */
  @media (max-width:980px){
    main{grid-template-columns:1fr}
    .board-wrap{flex-direction:column;align-items:center}
    .panel{position:relative;top:auto}
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M12 3L21 9L16 21H8L3 9L12 3Z" stroke="url(#g1)" stroke-width="1.2" stroke-linejoin="round"/><defs><linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#7c3aed"/><stop offset="1" stop-color="#06b6d4"/></linearGradient></defs></svg>
      </div>
      <div>
        <h1>Mines — Mini Juegos</h1>
        <p class="sub">Estilo profesional — tablero 5x5 configurable en minas. Lógica real y cashout.</p>
      </div>
    </div>
    <div class="controls">
      <div style="background:var(--glass);padding:8px 12px;border-radius:999px;border:1px solid var(--glass-border);display:flex;gap:8px;align-items:center">
        <div style="width:10px;height:10px;border-radius:50%;background:linear-gradient(90deg,#34d399,#10b981)"></div>
        <div style="font-weight:700">0.524 BTC</div>
        <div style="font-size:12px;color:var(--muted)">Balance</div>
      </div>
    </div>
  </header>

  <main>
    <section class="game-card" aria-labelledby="gameTitle">
      <div class="top-row">
        <div>
          <div style="display:flex;gap:8px;align-items:center">
            <h2 id="gameTitle" style="margin:0;font-size:16px">Mines — 5 x 5</h2>
            <div class="small" style="margin-left:6px">Tablero fijo</div>
          </div>
          <div class="small" style="margin-top:6px">Selecciona cantidad de minas, apuesta y comienza. Pulsa sobre una casilla para descubrir. Haz cashout antes de explotar.</div>
        </div>

        <div class="controls">
          <select id="mineSelect" class="select" title="Cantidad de minas">
            <!-- options will be injected -->
          </select>
          <input id="betInput" class="input" type="number" min="0.0001" step="0.0001" value="0.01" title="Apuesta (BTC)" />
          <button id="startBtn" class="btn">Iniciar</button>
        </div>
      </div>

      <div class="board-wrap">
        <div class="board" id="board" aria-live="polite"></div>

        <div style="width:320px">
          <div class="panel" aria-labelledby="panelTitle">
            <h3 id="panelTitle" style="margin:0 0 8px">Panel</h3>

            <div class="stat"><div class="small">Estado</div><strong id="stateLabel">Inactivo</strong></div>
            <div class="stat"><div class="small">Apuesta</div><strong id="betLabel">-</strong></div>
            <div class="stat"><div class="small">Minas</div><strong id="minesLabel">-</strong></div>
            <div class="stat"><div class="small">Reveladas</div><strong id="revealedLabel">0</strong></div>
            <div class="stat"><div class="small">Multiplicador actual</div><strong id="multLabel">-</strong></div>
            <div class="stat"><div class="small">Pago al cashout</div><strong id="payoutLabel">-</strong></div>

            <div style="display:flex;gap:10px;margin-top:12px">
              <button id="cashoutBtn" class="btn warn ghost" style="flex:1" disabled>Cashout</button>
              <button id="resetBtn" class="btn ghost" style="flex:1">Reiniciar</button>
            </div>

            <div style="margin-top:12px">
              <div class="small">Última partida</div>
              <div id="lastResult" style="margin-top:6px;color:var(--muted)">Sin historial</div>
            </div>

            <div class="footer-note">Diseño mockup — sin integración de pagos reales.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- right column could be used for tips, leaderboard, etc. keep minimal -->
    <aside>
      <div class="panel">
        <h4 style="margin:0 0 8px">Ayuda rápida</h4>
        <p class="small" style="margin:0 0 8px">• Elige cuántas minas habrá (1–24).<br>• A mayor cantidad de minas, mayor riesgo y mayor multiplicador inicial.<br>• Revela casillas seguras para aumentar el multiplicador. Haz cashout antes de explotar.</p>

        <h4 style="margin-top:12px;margin-bottom:8px">Multiplicador estimado</h4>
        <p class="small" style="margin:0 0 12px">La fórmula que usamos: <code>mult = 25 / (25 - minas - reveladas)</code> — aumenta a medida que revelás casillas seguras.</p>

        <h4 style="margin-top:12px;margin-bottom:8px">RTP & límites</h4>
        <p class="small" style="margin:0">RTP teórico depende de la estrategia. Este juego es una simulación para fines de diseño.</p>
      </div>
    </aside>
  </main>
</div>

<!-- modal -->
<div class="modal" id="modal">
  <div class="modal-card" role="dialog" aria-modal="true">
    <div style="display:flex;justify-content:space-between;align-items:center"><strong id="modalTitle">Resultado</strong><button onclick="closeModal()" class="btn ghost">Cerrar</button></div>
    <div id="modalBody" style="margin-top:12px;color:var(--muted)"></div>
  </div>
</div>

<script>
  // === Helpers and initial setup ===
  const BOARD_SIZE = 25; // 5x5 fixed
  const boardEl = document.getElementById('board');
  const mineSelect = document.getElementById('mineSelect');
  const startBtn = document.getElementById('startBtn');
  const betInput = document.getElementById('betInput');
  const stateLabel = document.getElementById('stateLabel');
  const betLabel = document.getElementById('betLabel');
  const minesLabel = document.getElementById('minesLabel');
  const revealedLabel = document.getElementById('revealedLabel');
  const multLabel = document.getElementById('multLabel');
  const payoutLabel = document.getElementById('payoutLabel');
  const cashoutBtn = document.getElementById('cashoutBtn');
  const resetBtn = document.getElementById('resetBtn');
  const lastResult = document.getElementById('lastResult');
  const modal = document.getElementById('modal');
  const modalBody = document.getElementById('modalBody');

  // populate mine select 1..24
  for(let i=1;i<=24;i++){
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = i + ' minas';
    if(i===5) opt.selected = true;
    mineSelect.appendChild(opt);
  }

  // Game state
  let mines = new Set();
  let revealed = new Set();
  let playing = false;
  let bet = 0;
  let mineCount = parseInt(mineSelect.value,10);
  let cells = [];

  function formatBTC(x){
    return parseFloat(x).toFixed(4);
  }

  function calcMultiplier(revealedCount, mineCount){
    // Avoid division by zero: if denominator reaches 0, return a high cap.
    const denom = 25 - mineCount - revealedCount;
    if(denom <= 0) return Number.POSITIVE_INFINITY;
    const mult = 25 / denom;
    return mult;
  }

  function updatePanel(){
    betLabel.innerText = bet ? `${formatBTC(bet)} BTC` : '-';
    minesLabel.innerText = mineCount;
    revealedLabel.innerText = revealed.size;
    const mult = calcMultiplier(revealed.size, mineCount);
    multLabel.innerText = (mult===Infinity) ? 'MAX' : `x ${mult.toFixed(4)}`;
    const payout = bet * (mult===Infinity ? 0 : mult);
    payoutLabel.innerText = (bet ? `${formatBTC(payout)} BTC` : '-');
    stateLabel.innerText = playing ? 'En juego' : 'Inactivo';
    cashoutBtn.disabled = !playing || revealed.size===0;
    cashoutBtn.classList.toggle('ghost', !playing);
  }

  function resetBoardUI(){
    boardEl.innerHTML = '';
    cells = [];
    for(let i=0;i<BOARD_SIZE;i++){
      const c = document.createElement('div');
      c.className = 'cell';
      c.dataset.index = i;
      c.innerHTML = `<div class="icon"></div><div class="pulse"></div>`;
      c.addEventListener('click', ()=>onCellClick(i));
      boardEl.appendChild(c);
      cells.push(c);
    }
  }

  function placeMines(){
    mines.clear();
    while(mines.size < mineCount){
      mines.add(Math.floor(Math.random()*BOARD_SIZE));
    }
    // console.log('Mines:', Array.from(mines));
  }

  function startGame(){
    bet = parseFloat(betInput.value);
    if(!bet || bet <= 0){
      alert('Ingresa una apuesta válida.');
      return;
    }
    mineCount = parseInt(mineSelect.value,10);
    revealed.clear();
    playing = true;
    placeMines();
    resetBoardUI();
    updatePanel();
    lastResult.innerText = 'Jugando...';
    // subtle entry animation
    boardEl.querySelectorAll('.cell').forEach((el,i)=>{ el.style.transform='translateY(8px)'; el.style.opacity='0'; setTimeout(()=>{ el.style.transition='transform .3s ease, opacity .3s ease'; el.style.transform='translateY(0)'; el.style.opacity='1'; }, i*35) });
  }

  function revealAllMines(){
    mines.forEach(idx=>{
      const el = cells[idx];
      if(el){
        el.classList.add('revealed','bomb');
        el.querySelector('.icon').textContent = '💣';
      }
    });
  }

  function showWin(){
    modalBody.innerHTML = `<div style="font-size:18px;margin-bottom:8px">¡Has ganado! 🎉</div>
      <div style="color:var(--muted)">Cobras <strong>${formatBTC(bet * calcMultiplier(revealed.size, mineCount))} BTC</strong></div>`;
    openModal();
  }

  function showLose(){
    modalBody.innerHTML = `<div style="font-size:18px;margin-bottom:8px">Has explotado 💥</div>
      <div style="color:var(--muted)">Perdiste la apuesta de <strong>${formatBTC(bet)} BTC</strong></div>`;
    openModal();
  }

  function endGame(result){
    playing = false;
    updatePanel();
    // reveal all mines
    revealAllMines();
    // disable pointer
    cells.forEach(c=>c.style.cursor='default');
    if(result === 'win'){
      showWin();
      lastResult.innerText = `Ganaste ${formatBTC(bet*calcMultiplier(revealed.size, mineCount))} BTC`;
    } else {
      showLose();
      lastResult.innerText = `Perdiste ${formatBTC(bet)} BTC`;
    }
  }

  function onCellClick(index){
    if(!playing) return;
    if(revealed.has(index)) return;

    const el = cells[index];

    // if it's a mine -> lose
    if(mines.has(index)){
      el.classList.add('revealed','bomb');
      el.querySelector('.icon').textContent = '💣';
      // small shake
      el.querySelector('.pulse').style.animation = 'shake .9s ease';
      setTimeout(()=> endGame('lose'), 450);
      return;
    }

    // safe cell
    revealed.add(index);
    el.classList.add('revealed','good');
    el.querySelector('.icon').textContent = '💎';

    updatePanel();

    // check if all safe cells revealed -> auto-win
    const safeCells = BOARD_SIZE - mineCount;
    if(revealed.size >= safeCells){
      // full clear -> win maximum
      setTimeout(()=> endGame('win'), 300);
    }
  }

  function cashout(){
    if(!playing || revealed.size===0) return;
    const mult = calcMultiplier(revealed.size, mineCount);
    const payout = bet * mult;
    // Flash success on revealed cells
    cells.forEach((c,idx)=>{
      if(revealed.has(idx)){
        c.classList.add('good');
      }
      c.style.cursor='default';
    });
    // mark as ended
    playing = false;
    updatePanel();
    modalBody.innerHTML = `<div style="font-size:18px;margin-bottom:8px">Cashout exitoso ✅</div>
      <div style="color:var(--muted)">Has retirado <strong>${formatBTC(payout)} BTC</strong></div>`;
    openModal();
    lastResult.innerText = `Cashout ${formatBTC(payout)} BTC`;
  }

  function resetAll(){
    playing = false;
    bet = 0;
    betInput.value = '0.01';
    revealed.clear();
    mines.clear();
    resetBoardUI();
    updatePanel();
    lastResult.innerText = 'Sin historial';
    stateLabel.innerText = 'Inactivo';
  }

  function openModal(){ modal.classList.add('open'); }
  function closeModal(){ modal.classList.remove('open'); }

  // attach events
  startBtn.addEventListener('click', startGame);
  cashoutBtn.addEventListener('click', cashout);
  resetBtn.addEventListener('click', resetAll);
  mineSelect.addEventListener('change', ()=>{ mineCount = parseInt(mineSelect.value,10); updatePanel(); });

  // init
  resetBoardUI();
  updatePanel();

  // accessibility: close modal with Escape
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal() });
</script>

<script>
/* Admin-controlled balance injection (reads ./admin.json).
   Default balance_ARS if missing: 1000
   This script replaces visible BTC amounts (e.g. "0.524 BTC") in text nodes with "<amount> ARS".
   Edit admin.json to change the balance for all pages at once.
*/
(function(){
  function formatNumber(n){
    try{ return new Intl.NumberFormat('es-AR').format(n); }catch(e){ return String(n); }
  }
  function applyBalance(bal){
    // Replace exact occurrences of numbers followed by BTC inside leaf nodes
    var btcRegex = /[\d\.,]+\s*BTC/;
    var nodes = Array.prototype.slice.call(document.querySelectorAll('body *'));
    nodes.forEach(function(el){
      // Only consider elements without child elements (leaf nodes) to avoid breaking structure
      if(el.children.length===0 && typeof el.textContent === 'string'){
        if(btcRegex.test(el.textContent)){
          el.textContent = el.textContent.replace(btcRegex, formatNumber(bal) + ' ARS');
        }
      }
    });
    // Also try some common ids/classes
    var ids = ['balanceLabel','betLabel'];
    ids.forEach(function(id){
      var el = document.getElementById(id);
      if(el) el.textContent = formatNumber(bal) + ' ARS';
    });
    // Elements with class "balance" - update their numeric portion if present
    Array.prototype.slice.call(document.querySelectorAll('.balance')).forEach(function(el){
      if(typeof el.textContent === 'string' && btcRegex.test(el.textContent)){
        el.textContent = el.textContent.replace(btcRegex, formatNumber(bal) + ' ARS');
      } else {
        var txt = el.textContent || '';
        if(txt.indexOf('BTC')!==-1){
          el.textContent = txt.replace(btcRegex, formatNumber(bal) + ' ARS');
        }
      }
    });
  }

  // Fetch admin.json from same folder
  fetch('./admin.json', {cache: 'no-store'}).then(function(r){
    if(!r.ok) throw new Error('no admin.json');
    return r.json();
  }).then(function(cfg){
    var bal = cfg && (typeof cfg.balance_ARS !== 'undefined') ? cfg.balance_ARS : 1000;
    applyBalance(bal);
  }).catch(function(err){
    // If fetch fails, apply default 1000 ARS
    applyBalance(1000);
    console.warn('admin.json not found or failed to load — using default 1000 ARS', err);
  });
})();
</script>
</body>
</html>

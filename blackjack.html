<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Blackjack — Mini Juegos (Moderno)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f1724;
    --card:#0b1220;
    --glass: rgba(255,255,255,0.04);
    --glass-2: rgba(255,255,255,0.03);
    --glass-border: rgba(255,255,255,0.06);
    --muted: rgba(255,255,255,0.65);
    --accent1-start:#7c3aed;
    --accent1-end:#06b6d4;
    --accent2-start:#f59e0b;
    --accent2-end:#ef4444;
    --success:#10b981;
    --danger:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:
      radial-gradient(800px 400px at 10% 10%, rgba(124,58,237,0.06), transparent 10%),
      radial-gradient(700px 350px at 90% 80%, rgba(6,182,212,0.04), transparent 10%),
      var(--bg);
    color:#e6eef8;
    -webkit-font-smoothing:antialiased;
    padding:28px;
  }

  .container{max-width:1200px;margin:0 auto}

  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#071025,#0b1220);display:grid;place-items:center;border:1px solid rgba(255,255,255,0.03)}
  h1{font-size:18px;margin:0}
  p.sub{margin:0;color:var(--muted);font-size:13px}

  main{display:grid;grid-template-columns:1fr 360px;gap:22px;align-items:start}

  /* Table/Game Card */
  .game-card{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:16px;padding:18px;border:1px solid var(--glass-border);
    box-shadow: 0 10px 30px rgba(2,6,23,0.6);
  }
  .top-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .select, .input {
    background:var(--glass);border:1px solid var(--glass-border);padding:10px 12px;border-radius:10px;color:inherit;
  }
  .btn{
    padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent1-start),var(--accent1-end));
    color:white;font-weight:700;cursor:pointer;box-shadow:0 8px 30px rgba(124,58,237,0.14);
  }
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);box-shadow:none;color:var(--muted)}
  .btn.warn{background:linear-gradient(90deg,var(--accent2-start),var(--accent2-end));box-shadow:0 8px 30px rgba(245,158,11,0.12)}
  .btn[disabled]{opacity:.5;cursor:not-allowed}

  .table-wrap{display:grid;grid-template-columns:1fr;gap:12px}
  .bj-table{
    background: radial-gradient(1200px 400px at 50% 120%, rgba(124,58,237,0.08), transparent 40%),
                radial-gradient(900px 400px at 50% -60%, rgba(6,182,212,0.06), transparent 40%),
                linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid var(--glass-border); border-radius:16px; padding:20px; position:relative;
    min-height:420px; display:flex; flex-direction:column; justify-content:space-between;
  }
  .hands{display:grid;grid-template-rows:auto 1fr auto;row-gap:16px}
  .dealer-area, .player-area{display:flex;flex-direction:column;gap:6px}
  .label{font-size:12px;color:var(--muted)}

  .hand{display:flex;align-items:flex-end;gap:8px;min-height:106px;flex-wrap:wrap}
  .card{width:64px;height:94px;border-radius:10px;background:linear-gradient(180deg,#0c1426,#091022);border:1px solid rgba(255,255,255,0.06);position:relative;box-shadow:0 12px 30px rgba(2,6,23,.5);display:grid;place-items:center;transform:translateY(8px);opacity:0}
  .card.show{transform:translateY(0);opacity:1;transition:transform .25s ease, opacity .25s ease}
  .card .rank{position:absolute;top:8px;left:10px;font-weight:800}
  .card .suit{position:absolute;bottom:8px;right:10px;font-size:18px}
  .card.face{background:linear-gradient(135deg,#111a33,#0c1426);}
  .card.back{background:linear-gradient(135deg,#1b2741,#131b2f); border:1px solid rgba(255,255,255,0.12)}
  .card.black{color:#e6eef8}
  .card.red{color:#fca5a5}

  .value-badge{display:inline-flex;align-items:center;gap:6px;background:var(--glass);border:1px solid var(--glass-border);padding:6px 10px;border-radius:999px;font-size:12px}
  .value-badge.good{background:rgba(16,185,129,0.15)}
  .value-badge.bust{background:rgba(239,68,68,0.15)}
  .value-badge.blackjack{background:linear-gradient(90deg,var(--accent1-start),var(--accent1-end));color:#fff}

  .chip-row{display:flex;gap:8px;flex-wrap:wrap}
  .chip{min-width:52px;padding:10px 12px;border-radius:999px;background:var(--glass);border:1px solid var(--glass-border);cursor:pointer}
  .chip.active{outline:2px solid rgba(124,58,237,.45)}

  .actions{display:flex;gap:10px;flex-wrap:wrap}

  .panel{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:16px;padding:18px;border:1px solid var(--glass-border);height:100%;
    position:sticky;top:28px;
  }
  .stat{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;margin-bottom:8px;background:var(--glass-2);border:1px solid rgba(255,255,255,0.02)}
  .stat strong{font-size:16px}
  .small{color:var(--muted);font-size:13px}
  .footer-note{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}

  .ribbon{position:absolute;top:12px;left:50%;transform:translateX(-50%);padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.06);border:1px solid var(--glass-border);font-size:12px}

  /* responsive */
  @media (max-width:980px){
    main{grid-template-columns:1fr}
    .panel{position:relative;top:auto}
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M12 3L21 9L16 21H8L3 9L12 3Z" stroke="url(#g1)" stroke-width="1.2" stroke-linejoin="round"/><defs><linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#7c3aed"/><stop offset="1" stop-color="#06b6d4"/></linearGradient></defs></svg>
      </div>
      <div>
        <h1>Blackjack — Mini Juegos</h1>
        <p class="sub">Estilo profesional — 6 mazos, acciones avanzadas (Doblar, Dividir, Seguro, Rendirse).</p>
      </div>
    </div>
    <div class="controls">
      <div style="background:var(--glass);padding:8px 12px;border-radius:999px;border:1px solid var(--glass-border);display:flex;gap:8px;align-items:center">
        <div style="width:10px;height:10px;border-radius:50%;background:linear-gradient(90deg,#34d399,#10b981)"></div>
        <div id="balanceLabel" style="font-weight:700">0.500 BTC</div>
        <div style="font-size:12px;color:var(--muted)">Balance</div>
      </div>
    </div>
  </header>

  <main>
    <section class="game-card" aria-labelledby="gameTitle">
      <div class="top-row">
        <div>
          <div style="display:flex;gap:8px;align-items:center">
            <h2 id="gameTitle" style="margin:0;font-size:16px">Blackjack Clásico 3:2</h2>
            <div class="small" style="margin-left:6px">6 mazos • Dealer se planta en 17 suave • Rebaraja al 75%</div>
          </div>
          <div class="small" style="margin-top:6px">Ajusta tu apuesta, presiona <strong>Repartir</strong> y juega. Diseño mockup sin pagos reales.</div>
        </div>
        <div class="controls">
          <input id="betInput" class="input" type="number" min="0.0001" step="0.0001" value="0.01" title="Apuesta (BTC)" />
          <div class="chip-row" aria-label="Chips">
            <button class="chip" data-chip="0.001">0.001</button>
            <button class="chip" data-chip="0.005">0.005</button>
            <button class="chip active" data-chip="0.01">0.01</button>
            <button class="chip" data-chip="0.05">0.05</button>
            <button class="chip" data-chip="0.1">0.1</button>
          </div>
          <button id="dealBtn" class="btn">Repartir</button>
        </div>
      </div>

      <div class="table-wrap">
        <div class="bj-table" id="table">
          <div class="ribbon" id="shoeInfo">Shoe: 6 mazos • Quedan 0%</div>

          <div id="winnerMessage" style="display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(17,24,39,0.85);padding:24px 40px;border-radius:16px;border:1px solid rgba(255,255,255,0.1);font-size:20px;font-weight:700;color:white;box-shadow:0 10px 40px rgba(0,0,0,0.5);z-index:50;">¡Ganaste!</div>
<div class="hands">
            <div class="dealer-area">
              <div class="label">Crupier <span id="dealerValue" class="value-badge">-</span></div>
              <div class="hand" id="dealerHand"></div>
            </div>

            <div class="player-area">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
                <div class="label">Jugador <span id="playerValue" class="value-badge">-</span> <span id="handIndexLabel" class="small" style="margin-left:8px"></span></div>
                <div class="actions">
                  <button id="hitBtn" class="btn ghost" disabled>Pedir</button>
                  <button id="standBtn" class="btn ghost" disabled>Plantarse</button>
                  <button id="doubleBtn" class="btn ghost" disabled>Doblar</button>
                  <button id="splitBtn" class="btn ghost" disabled>Dividir</button>
                  <button id="surrenderBtn" class="btn ghost" disabled>Rendirse</button>
                  <button id="insureBtn" class="btn ghost" disabled>Seguro</button>
                </div>
              </div>
              <div class="hand" id="playerHands"></div>
            </div>

            <div>
              <div class="label">Resultados</div>
              <div id="lastResult" class="small" style="padding:8px;border-radius:10px;border:1px solid var(--glass-border);background:var(--glass-2)">Sin historial</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <aside>
      <div class="panel">
        <h4 style="margin:0 0 8px">Panel</h4>
        <div class="stat"><div class="small">Estado</div><strong id="stateLabel">Apostando</strong></div>
        <div class="stat"><div class="small">Apuesta</div><strong id="betLabel">0.0100 BTC</strong></div>
        <div class="stat"><div class="small">Seguro</div><strong id="insLabel">-</strong></div>
        <div class="stat"><div class="small">Pago previsto</div><strong id="payoutLabel">-</strong></div>
        <div class="stat"><div class="small">Partidas</div><strong id="roundsLabel">0</strong></div>
        <div class="stat"><div class="small">W / L / D</div><strong id="wldLabel">0 / 0 / 0</strong></div>
        <div class="stat"><div class="small">RTP Sim.</div><strong id="rtpLabel">-</strong></div>
        <div style="display:flex;gap:10px;margin-top:12px">
          <button id="newShoeBtn" class="btn warn ghost" style="flex:1">Nuevo Shoe</button>
          <button id="resetBtn" class="btn ghost" style="flex:1">Reiniciar</button>
        </div>
        <div class="footer-note" style="margin-top:12px">Reglas: BJ paga 3:2. Dealer se planta en 17 suave (A+6). Doble tras split permitido una vez. Dividir máx 1 vez (2 manos). Rendirse tardío permitido.</div>
      </div>
    </aside>
  </main>
</div>

<script>
// ======= Utilidades de cartas =======
const SUITS = ['♠','♥','♦','♣'];
const RANKS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
const RANK_VALUE = (r)=> r === 'A' ? 11 : (['J','Q','K'].includes(r)?10:parseInt(r));

function createDecks(n=6){
  const d=[]; for(let i=0;i<n;i++){ for(const s of SUITS){ for(const r of RANKS){ d.push({r,s}); } }} return d;
}
function shuffle(a){
  for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a;
}

function handValue(cards){
  let total = 0; let aces=0;
  for(const c of cards){ total += RANK_VALUE(c.r); if(c.r==='A') aces++; }
  while(total>21 && aces>0){ total -= 10; aces--; }
  const soft = cards.some(c=>c.r==='A') && total<=21 && (total+10)<=21 && cards.length>0 ? true : (cards.some(c=>c.r==='A') && total<=21 && aces>0);
  const isBJ = cards.length===2 && total===21;
  const bust = total>21;
  return {total, soft, isBlackjack:isBJ, bust};
}

function cardEl(card){
  const el = document.createElement('div');
  el.className = `card face ${['♥','♦'].includes(card.s)?'red':'black'}`;
  el.innerHTML = `<div class="rank">${card.r}</div><div class="suit">${card.s}</div>`;
  requestAnimationFrame(()=> el.classList.add('show'));
  return el;
}
function backEl(){
  const el = document.createElement('div'); el.className='card back'; requestAnimationFrame(()=> el.classList.add('show')); return el;
}

// ======= Estado del juego =======
const dealerHandEl = document.getElementById('dealerHand');
const playerHandsEl = document.getElementById('playerHands');
const dealerValueEl = document.getElementById('dealerValue');
const playerValueEl = document.getElementById('playerValue');
const handIndexLabel = document.getElementById('handIndexLabel');

const dealBtn = document.getElementById('dealBtn');
const hitBtn = document.getElementById('hitBtn');
const standBtn = document.getElementById('standBtn');
const doubleBtn = document.getElementById('doubleBtn');
const splitBtn = document.getElementById('splitBtn');
const surrenderBtn = document.getElementById('surrenderBtn');
const insureBtn = document.getElementById('insureBtn');

const betInput = document.getElementById('betInput');
const chips = Array.from(document.querySelectorAll('.chip'));
const balanceLabel = document.getElementById('balanceLabel');

const shoeInfo = document.getElementById('shoeInfo');
const stateLabel = document.getElementById('stateLabel');
const betLabel = document.getElementById('betLabel');
const insLabel = document.getElementById('insLabel');
const payoutLabel = document.getElementById('payoutLabel');
const lastResult = document.getElementById('lastResult');
const roundsLabel = document.getElementById('roundsLabel');
const wldLabel = document.getElementById('wldLabel');
const rtpLabel = document.getElementById('rtpLabel');

const resetBtn = document.getElementById('resetBtn');
const newShoeBtn = document.getElementById('newShoeBtn');

let GAME = {
  shoe: [],
  discard: [],
  decks: 6,
  cutPenetration: 0.75, // rebarajar cuando quede 25%
  balance: 0.5,
  bet: 0.01,
  rounds: 0, wins:0, losses:0, pushes:0, paid:0, wagered:0,
  state: 'betting', // 'dealing','player','dealer','settle'
  insuranceBet: 0,
  allowDividirOnce: true,
  hands: [], // [{cards:[], bet: number, done:bool, doubled:bool, surrendered:bool}]
  activeHandIndex: 0,
  dealer: { cards: [], holeHidden: true }
};

function formatBTC(x){ return parseFloat(x).toFixed(4); }
function updateBalance(){ balanceLabel.innerText = `${formatBTC(GAME.balance)} BTC`; }
function updateBetLabel(){ betLabel.innerText = `${formatBTC(GAME.bet)} BTC`; }
function updateWLD(){ wldLabel.innerText = `${GAME.wins} / ${GAME.losses} / ${GAME.pushes}`; roundsLabel.innerText = `${GAME.rounds}`; const rtp = GAME.wagered>0 ? (100*GAME.paid/GAME.wagered).toFixed(2)+"%" : '-'; rtpLabel.innerText = rtp; }

function initShoe(){ GAME.shoe = shuffle(createDecks(GAME.decks)); GAME.discard = []; renderShoeInfo(); }
function renderShoeInfo(){ const pct = Math.max(0, Math.round((1 - (GAME.shoe.length/(GAME.decks*52)))*100)); shoeInfo.innerText = `Shoe: ${GAME.decks} mazos • Jugado ${pct}%`; }

function canDeal(){ return GAME.state==='betting' && GAME.bet>0 && GAME.balance>=GAME.bet; }
function setState(s){ GAME.state=s; stateLabel.innerText = s==='betting'?'Apostando': s==='dealing'?'Repartiendo': s==='player'?'Tu turno': s==='dealer'?'Crupier': 'Resolviendo'; }

function clearHandsUI(){ dealerHandEl.innerHTML=''; playerHandsEl.innerHTML=''; dealerValueEl.innerText='-'; playerValueEl.innerText='-'; handIndexLabel.innerText=''; payoutLabel.innerText='-'; insLabel.innerText='-'; }

function pushToDiscard(cards){ GAME.discard.push(...cards); }
function drawCard(){ if(GAME.shoe.length===0) initShoe(); const c = GAME.shoe.pop(); renderShoeInfo(); return c; }

function startRound(){
  if(!canDeal()) { alert('Saldo insuficiente o apuesta inválida.'); return; }
  if(GAME.shoe.length < (GAME.decks*52)*(1-GAME.cutPenetration)) initShoe();
  setState('dealing'); clearHandsUI();
  GAME.balance -= GAME.bet; updateBalance();
  GAME.wagered += GAME.bet; updateWLD();
  GAME.insuranceBet = 0; insLabel.innerText='-';
  GAME.hands = [{cards:[], bet: GAME.bet, done:false, doubled:false, surrendered:false, split:false}];
  GAME.activeHandIndex = 0; GAME.dealer = {cards:[], holeHidden:true};

  // repartir
  for(let i=0;i<2;i++){
    GAME.hands[0].cards.push(drawCard());
    GAME.dealer.cards.push(drawCard());
  }
  renderAll();

  // seguro si As visible
  offerSeguroIfAce();

  // check dealer BJ
  if(handValue(GAME.dealer.cards).isBlackjack){
    revealDealerHole();
    settleRound();
    return;
  }

  // jugador BJ
  if(handValue(GAME.hands[0].cards).isBlackjack){
    // pagar 3:2
    const payout = GAME.bet * 2.5; // retorna apuesta + ganancia 1.5x
    GAME.balance += payout; GAME.paid += payout; updateBalance();
    lastResult.innerText = `Blackjack! Pagado ${formatBTC(payout)} BTC`;
    GAME.wins++; GAME.rounds++; updateWLD(); setState('settle');
    revealDealerHole();
    return;
  }

  // turno jugador
  enableActionsForActiveHand(); setState('player');
}

function renderAll(){
  // Dealer
  dealerHandEl.innerHTML='';
  GAME.dealer.cards.forEach((c,i)=>{
    if(i===1 && GAME.dealer.holeHidden){ dealerHandEl.appendChild(backEl()); }
    else dealerHandEl.appendChild(cardEl(c));
  });
  const dVal = handValue(GAME.dealer.cards);
  dealerValueEl.className = 'value-badge';
  dealerValueEl.innerText = GAME.dealer.holeHidden ? `${RANK_VALUE(GAME.dealer.cards[0].r)}` : (dVal.bust?`${dVal.total} (Bust)`:`${dVal.total}${dVal.soft?' (Soft)':''}`);

  // Player hands
  playerHandsEl.innerHTML='';
  GAME.hands.forEach((h,idx)=>{
    const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.flexDirection='column'; wrap.style.gap='6px';
    const label = document.createElement('div'); label.className='small'; label.innerHTML = `Mano ${idx+1} — <strong>${formatBTC(h.bet)} BTC</strong>`; wrap.appendChild(label);
    const row = document.createElement('div'); row.className='hand'; row.id = `hand-${idx}`; wrap.appendChild(row);
    h.cards.forEach(c=> row.appendChild(cardEl(c)) );
    playerHandsEl.appendChild(wrap);
  });

  const cur = currentHand();
  const pVal = handValue(cur.cards);
  playerValueEl.className = 'value-badge' + (pVal.isBlackjack?' blackjack':'') + (pVal.bust?' bust':'') + (!pVal.bust && pVal.total>=18?' good':'');
  playerValueEl.innerText = pVal.bust? `${pVal.total} (Bust)` : `${pVal.total}${pVal.soft?' (Soft)':''}`;

  handIndexLabel.innerText = GAME.hands.length>1 ? `Jugando mano ${GAME.activeHandIndex+1} de ${GAME.hands.length}` : '';
}

function currentHand(){ return GAME.hands[GAME.activeHandIndex]; }

function enableActionsForActiveHand(){
  const h = currentHand();
  const canDoblar = h.cards.length===2 && GAME.balance >= h.bet; // requiere saldo para doblar
  const canDividir = h.cards.length===2 && h.cards[0].r===h.cards[1].r && GAME.allowDividirOnce && GAME.balance >= h.bet && !h.split;
  const canRendirse = h.cards.length===2 && !h.doubled && !h.split;
  const dealerUp = GAME.dealer.cards[0];

  hitBtn.disabled = false; standBtn.disabled=false; doubleBtn.disabled = !canDoblar; splitBtn.disabled = !canDividir; surrenderBtn.disabled = !canRendirse; 
  insureBtn.disabled = !(dealerUp.r==='A' && GAME.dealer.holeHidden && GAME.insuranceBet===0 && GAME.balance >= h.bet/2);
}

function disableAllActions(){ hitBtn.disabled = standBtn.disabled = doubleBtn.disabled = splitBtn.disabled = surrenderBtn.disabled = insureBtn.disabled = true; }

function offerSeguroIfAce(){
  const up = GAME.dealer.cards[0];
  if(up.r==='A' && GAME.dealer.holeHidden){ insureBtn.disabled=false; insLabel.innerText='Oferta'; }
}

function revealDealerHole(){ GAME.dealer.holeHidden=false; renderAll(); }

// ======= Acciones =======
function hit(){
  if(GAME.state!=='player') return;
  const h = currentHand(); h.cards.push(drawCard()); renderAll();
  const v = handValue(h.cards);
  if(v.bust){ nextHandOrDealer(); }
  else enableActionsForActiveHand();
}
function stand(){ if(GAME.state!=='player') return; nextHandOrDealer(); }
function doubleDown(){
  if(GAME.state!=='player') return; const h=currentHand(); if(h.cards.length!==2 || GAME.balance < h.bet) return;
  GAME.balance -= h.bet; updateBalance(); GAME.wagered += h.bet; updateWLD(); h.bet *= 2; h.doubled = true; h.cards.push(drawCard()); renderAll(); nextHandOrDealer();
}
function split(){
  if(GAME.state!=='player') return; const h=currentHand(); if(!(h.cards.length===2 && h.cards[0].r===h.cards[1].r)) return; if(!GAME.allowDividirOnce) return; if(GAME.balance < h.bet) return;
  GAME.balance -= h.bet; updateBalance(); GAME.wagered += h.bet; updateWLD();
  const card2 = h.cards.pop();
  const newHand = {cards:[card2], bet:h.bet, done:false, doubled:false, surrendered:false, split:true};
  h.split = true;
  GAME.hands.splice(GAME.activeHandIndex+1,0,newHand);
  // repartir una carta a cada mano
  h.cards.push(drawCard()); newHand.cards.push(drawCard());
  GAME.allowDividirOnce = false; renderAll(); enableActionsForActiveHand();
}
function surrender(){
  if(GAME.state!=='player') return; const h=currentHand(); if(!(h.cards.length===2) || h.doubled) return;
  h.surrendered = true; h.done = true; const refund = h.bet/2; GAME.balance += refund; GAME.paid += refund; updateBalance(); lastResult.innerText = `Rendirse: reembolso ${formatBTC(refund)} BTC`;
  nextHandOrDealer();
}
function insure(){
  if(GAME.state!=='player') return; const h=currentHand(); if(!(GAME.dealer.cards[0].r==='A') || GAME.insuranceBet>0 || GAME.balance < h.bet/2) return;
  GAME.insuranceBet = h.bet/2; GAME.balance -= GAME.insuranceBet; GAME.wagered += GAME.insuranceBet; updateBalance(); insLabel.innerText = `${formatBTC(GAME.insuranceBet)} BTC`;
  // chequeo inmediato si el crupier tiene BJ
  const d = handValue(GAME.dealer.cards);
  if(d.isBlackjack){
    revealDealerHole();
    // seguro paga 2:1
    const pay = GAME.insuranceBet*3; GAME.balance += pay; GAME.paid += pay; updateBalance(); lastResult.innerText = `Dealer Blackjack. Seguro paga ${formatBTC(pay)} BTC`;
    settleRound();
  } else {
    lastResult.innerText = `Seguro apostado ${formatBTC(GAME.insuranceBet)} BTC`;
    enableActionsForActiveHand();
  }
}

function nextHandOrDealer(){
  // si quedan manos por jugar
  GAME.hands[GAME.activeHandIndex].done = true;
  for(let i=0;i<GAME.hands.length;i++){
    if(!GAME.hands[i].done){ GAME.activeHandIndex = i; renderAll(); enableActionsForActiveHand(); return; }
  }
  // turno del dealer
  disableAllActions(); setState('dealer'); revealDealerHole();
  const play = ()=>{
    const dVal = handValue(GAME.dealer.cards);
    if(dVal.total<17 || (dVal.total===17 && dVal.soft)){ GAME.dealer.cards.push(drawCard()); renderAll(); setTimeout(play, 450); }
    else settleRound();
  };
  setTimeout(play, 450);
}

function settleRound(){
  setState('settle');
  const dVal = handValue(GAME.dealer.cards);
  let roundText=[]; let wins=0, losses=0, pushes=0; let totalPaid=0;

  // resolver seguro si no se resolvió
  if(GAME.insuranceBet>0 && !dVal.isBlackjack){ // pierde seguro
    roundText.push(`Seguro perdido (${formatBTC(GAME.insuranceBet)} BTC)`);
  }

  for(const h of GAME.hands){
    const pVal = handValue(h.cards);
    if(h.surrendered){ losses++; roundText.push(`Mano ${formatBTC(h.bet)}: Rendirse (-${formatBTC(h.bet/2)})`); continue; }
    if(pVal.bust){ losses++; roundText.push(`Mano ${formatBTC(h.bet)}: Bust`); continue; }
    if(dVal.bust){ const pay = h.bet*2; GAME.balance += pay; GAME.paid += pay; totalPaid+=pay; wins++; roundText.push(`Mano ${formatBTC(h.bet)}: Gana (+${formatBTC(h.bet)})`); continue; }

    if(pVal.total>dVal.total){ const pay=h.bet*2; GAME.balance += pay; GAME.paid += pay; totalPaid+=pay; wins++; roundText.push(`Mano ${formatBTC(h.bet)}: Gana (+${formatBTC(h.bet)})`); }
    else if(pVal.total<dVal.total){ losses++; roundText.push(`Mano ${formatBTC(h.bet)}: Pierde`); }
    else { // push
      const pay=h.bet; GAME.balance += pay; GAME.paid += pay; totalPaid+=pay; pushes++; roundText.push(`Mano ${formatBTC(h.bet)}: Push (devolución)`); }
  }

  GAME.rounds++; GAME.wins+=wins; GAME.losses+=losses; GAME.pushes+=pushes; updateWLD(); updateBalance();
  lastResult.innerText = roundText.join(' • ');

  // preparar siguiente ronda
  GAME.hands.forEach(h=> pushToDiscard(h.cards)); pushToDiscard(GAME.dealer.cards);
  GAME.allowDividirOnce = true; GAME.state='betting'; stateLabel.innerText='Apostando';
  dealerValueEl.className='value-badge'; playerValueEl.className='value-badge';
  // payout previsto vuelve a '-'
  payoutLabel.innerText='-';
}

// ======= UI/Eventos =======
chips.forEach(ch=> ch.addEventListener('click', ()=>{ chips.forEach(c=>c.classList.remove('active')); ch.classList.add('active'); betInput.value = ch.dataset.chip; GAME.bet=parseFloat(ch.dataset.chip); updateBetLabel(); }));

betInput.addEventListener('input', ()=>{ const v = Math.max(0, parseFloat(betInput.value)||0); GAME.bet=v; updateBetLabel(); });

dealBtn.addEventListener('click', startRound);

hitBtn.addEventListener('click', hit);
standBtn.addEventListener('click', stand);
doubleBtn.addEventListener('click', doubleDown);
splitBtn.addEventListener('click', split);
surrenderBtn.addEventListener('click', surrender);
insureBtn.addEventListener('click', insure);

resetBtn.addEventListener('click', ()=>{
  GAME.balance = 0.5; GAME.bet = 0.01; GAME.rounds=GAME.wins=GAME.losses=GAME.pushes=GAME.paid=GAME.wagered=0; betInput.value='0.01'; chips.forEach(c=> c.classList.toggle('active', c.dataset.chip==='0.01'));
  updateBalance(); updateBetLabel(); updateWLD(); lastResult.innerText='Sin historial'; clearHandsUI(); setState('betting');
});

newShoeBtn.addEventListener('click', ()=>{ initShoe(); lastResult.innerText='Nuevo shoe barajado'; });

function refreshPayoutPreview(){
  if(GAME.state!=='player'){ payoutLabel.innerText='-'; return; }
  const h=currentHand(); const v=handValue(h.cards); if(v.bust){ payoutLabel.innerText='-'; return; }
  // preview simple: si te plantas ahora vs dealer boca abajo (promedio no trivial). Mostramos valor actual nada más.
  payoutLabel.innerText = `${v.total}${v.soft?' (Soft)':''}`;
}

// init
initShoe(); updateBalance(); updateBetLabel(); updateWLD(); clearHandsUI(); setState('betting');

// accesibilidad
document.addEventListener('keydown', (e)=>{
  if(GAME.state==='player'){
    if(e.key==='h' || e.key==='H') hit();
    if(e.key==='s' || e.key==='S') stand();
    if(e.key==='d' || e.key==='D') doubleDown();
  }
});


// Mostrar mensaje elegante de ganador
function showWinnerMessage(texto, color='white'){
  const msg = document.getElementById('winnerMessage');
  msg.innerText = texto;
  msg.style.color = color;
  msg.style.display = 'block';
  setTimeout(()=> msg.style.display='none', 2500);
}

// Ajuste en settleRound() para mostrar mensaje elegante
const oldSettleRound = settleRound;
settleRound = function(){
  oldSettleRound();
  const dVal = handValue(GAME.dealer.cards);
  const lastText = lastResult.innerText.toLowerCase();
  if(lastText.includes('gana')) showWinnerMessage('¡Ganaste!', '#10b981');
  else if(lastText.includes('pierde')) showWinnerMessage('Perdiste', '#ef4444');
  else if(lastText.includes('push')) showWinnerMessage('Empate', '#f59e0b');
};

// observar cambios para preview
setInterval(refreshPayoutPreview, 400);
</script>

<script>
/* Admin-controlled balance injection (reads ./admin.json).
   Default balance_ARS if missing: 1000
   This script replaces visible BTC amounts (e.g. "0.524 BTC") in text nodes with "<amount> ARS".
   Edit admin.json to change the balance for all pages at once.
*/
(function(){
  function formatNumber(n){
    try{ return new Intl.NumberFormat('es-AR').format(n); }catch(e){ return String(n); }
  }
  function applyBalance(bal){
    // Replace exact occurrences of numbers followed by BTC inside leaf nodes
    var btcRegex = /[\d\.,]+\s*BTC/;
    var nodes = Array.prototype.slice.call(document.querySelectorAll('body *'));
    nodes.forEach(function(el){
      // Only consider elements without child elements (leaf nodes) to avoid breaking structure
      if(el.children.length===0 && typeof el.textContent === 'string'){
        if(btcRegex.test(el.textContent)){
          el.textContent = el.textContent.replace(btcRegex, formatNumber(bal) + ' ARS');
        }
      }
    });
    // Also try some common ids/classes
    var ids = ['balanceLabel','betLabel'];
    ids.forEach(function(id){
      var el = document.getElementById(id);
      if(el) el.textContent = formatNumber(bal) + ' ARS';
    });
    // Elements with class "balance" - update their numeric portion if present
    Array.prototype.slice.call(document.querySelectorAll('.balance')).forEach(function(el){
      if(typeof el.textContent === 'string' && btcRegex.test(el.textContent)){
        el.textContent = el.textContent.replace(btcRegex, formatNumber(bal) + ' ARS');
      } else {
        var txt = el.textContent || '';
        if(txt.indexOf('BTC')!==-1){
          el.textContent = txt.replace(btcRegex, formatNumber(bal) + ' ARS');
        }
      }
    });
  }

  // Fetch admin.json from same folder
  fetch('./admin.json', {cache: 'no-store'}).then(function(r){
    if(!r.ok) throw new Error('no admin.json');
    return r.json();
  }).then(function(cfg){
    var bal = cfg && (typeof cfg.balance_ARS !== 'undefined') ? cfg.balance_ARS : 1000;
    applyBalance(bal);
  }).catch(function(err){
    // If fetch fails, apply default 1000 ARS
    applyBalance(1000);
    console.warn('admin.json not found or failed to load — using default 1000 ARS', err);
  });
})();
</script>
</body>
</html>
